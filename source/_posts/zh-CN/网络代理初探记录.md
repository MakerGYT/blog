---
title: 网络代理初探记录
date: 2018-12-24 17:30:30
tags:
    - shadowsocks
categories: record
---

# 一、概述：
主要由两部分组成:服务端(中介)和客户端
<!-- more -->
# 二、准备材料：
- 资金：>=$10
- Paypal账户：绑定信用卡
- 本地工具：ubuntu terminal(用到ssh,ftp,git) 

# 三、开工：

## 3.1 服务端配置

### 3.1.1 注册vultr账户

> Vultr, founded in 2014, is on a mission to empower developers and businesses by simplifying the deployment of infrastructure via its advanced cloud platform. 

注册链接[https://www.vultr.com/?ref=7533527](https://www.vultr.com/?ref=7533527)

该服务商采用的是先充值后消费，按量计费。然后deploy一台服务器，规格如下：

| Server Location        | New York (NJ) | 
| ------------- |:-------------:| 
| Server Type     | Ubuntu 16.04 x64 | 
| Server Size  | 25 GB  `SSD` 1 `CPU` 1024MB `Memory` 1000GB `Bandwidth` （ $5/month）|   
| Other options | Temporary default |  

完成后会生成随机密码（不支持直接修改），通过提供的console或远程shell工具登录服务器后修改root用户密码(`sudo passwd root`)。

### 3.1.2 安装

安装SS

```python
#install basic pip dependency:
apt install python-pip #default 8.1.1
pip install --upgrade pip #to 18.1 close current terminal and restart
pip install setuptools
#start core work
pip install shadowsocks
```
或者
```linux
#install:shadowsocks-libev
sudo apt-get install software-properties-common -y
sudo add-apt-repository ppa:max-c-lv/shadowsocks-libev -y
sudo apt-get update
sudo apt install shadowsocks-libev
```
在`/etc`下新建一个配置文件
```
vim /etc/shadowsocks.json
```
配置内容如下：
```python
 {
 "server": "3.1.1中server的公网ip",
 "server_port": 8388,#注册端口范围1024~65535内均可
 "local_address": "127.0.0.1",
 "local_port": 1080,
 "password": "客户端用来连接的密码",
 "timeout": 300,
 "method": "aes-256-cfb",
 "fast_open": false
 }
```

{% note primary %}
如需多人使用，配置内容如下
端口1和端口2填两个不同的端口，如8388 8389
密码1和密码2是两个端口对应的登录密码，可不同
```python
{
"server": "服务器ip",
"port_password": {
"端口1": "密码1",
"端口2": "密码2"
},
"timeout": 300,
"method": "aes-256-cfb",
"fast_open": false
}
```
{% endnote %}

保存配置文件后，启动服务端
```
ssserver -c /etc/shadowsocks.json -d start
```
本地测试服务端是否可连接`telnet ip地址 8388`，若不通需在服务器中配置防火墙，永久开启此TCP端口，官方安全组配置无效。

### 3.1.3 bbr 加速

#### 3.1.3.1 升级内核

#### 3.1.3.2 修改系统变量：
```sh
sudo echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
sudo echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
#保存生效
sysctl -p
#测试
sysctl net.ipv4.tcp_available_congestion_control
#如果返回结果，则开启成功
net.ipv4.tcp_available_congestion_control = bbr cubic reno
```

## 3.2 客户端配置

### 3.2.1 GUI客户端:Windows、Mac、Android、iOS版本
[https://github.com/shadowsocks/shadowsocks/wiki/Ports-and-Clients](https://github.com/shadowsocks/shadowsocks/wiki/Ports-and-Clients)
### 3.2.2 ubuntu客户端

#### 3.2.2.1 基础配置

```sh
#首先需要保证网络是畅通的，然后更新软件源：
sudo apt-get update
#安装python-pip
sudo apt-get install python-pip
#安装ss
sudo pip install shadowsocks
#配置ss
sudo vim /etc/shadowsocks.json
# shadowsocks.json
{
    "server": "同3.2.1服务器公网ip",
    "server_port": 同3.2.1服务器端口,
    "local_address": "127.0.0.1",
    "local_port": 1080,
    "password": "同3.2.1SS密码",
    "method": "aes-256-cfb",
    "fast_open": true,
    "timeout":300
}
#启动SS
sudo sslocal -c /etc/shadowsocks.json 
```
上述命令执行后，此终端不能关闭，可通过`nohup/setsid`实现后台运行，通过rc.local实现开机自启(此处考虑日常访问实际未采用)。

#### 3.2.2.1 privoxy配置
privoxy实现将sock5代理映射为http代理
```sh
#安装privoxy
sudo apt-get install privoxy
#配置privoxy
vim /etc/privoxy/config
# config：
#4.1节取消注释`listen-address localhost:8118`
#5.2节末尾加入 `forward-socks5 / 127.0.0.1:1080 .`
#重启privoxy服务
sudo /etc/init.d/privoxy restart
#开机自启privoxy服务
systemctl enable privoxy
#查看privoxy服务状态
systemctl status privoxy
```

#### 3.2.2.2 代理配置
实现终端内可访问
1.  终端代理
    将以下代码追加到`/etc/profile`中或者`~/.bashrc`中
```sh
export http_proxy="127.0.0.1:8118"
export https_proxy="127.0.0.1:8118"
export ftp_proxy="127.0.0.1:8118"
```
接着执行`source /etc/profile`或者`source ~/.bashrc`
2. 浏览器代理
在浏览器的proxy settings中手动配置如下：firefox为例

| Http Proxy        | 127.0.0.1 | 8118  |
| ------------- |:-------------:| -----:|
| SSL Proxy  | 127.0.0.1 | 8118 |
| ftp Proxy  | 127.0.0.1 | 8118 |
| sockets Proxy| 127.0.0.1 | 8118|

勾选Use this proxy server for all protocols

3. 全局代理
在ubuntu setting->Network->Network proxy,method选择Manual，代理配置项与上述浏览器一致。
开启3代理后即终端或是浏览器上网均走代理，可根据访问位置选择代理方式。

# 四、测试
终端内开启后可wget一个 foreign domain检验其index.html是否可下载，浏览器访问网站请求时，shadowsocks服务窗口会显示当前请求信息
andriod或pc点击开启后，浏览器访问foreign domain测试

# 五、进阶
通过使用[shadowsocks-manager](https://github.com/shadowsocks/shadowsocks-manager)构建多用户管理和流量控制界面,普通用户可直接通过[https://vpn.makergyt.com](https://vpn.makergyt.com)注册使用，省去配置服务端工作，也可为维护者带来一定收益。

# Reference

<small>[1]Geyh.[Ubuntu系统SS搭建配置](http://blog.51cto.com/13589319/2068374).51CTO.2018.
[2]EXP.[Centos + Shadowsocks客户端 + Privoxy实现外网访问](http://exp-blog.com/2018/07/04/pid-1591/).exp-blog.2018,</small>