---
title: 反向编译wxapkg记录
date: 2019-04-03 20:30:37
tags:
  - wechat
categories: record
---
# 0.目的
一些小程序出于各种考虑并没有开放源代码，但是有时开发者想要了解学习其中的实现过程，需要去看到源码。当然，应该对开发者报以由衷敬意去阅读。

<!-- more -->

# 1.原理

根据微信官方关于小程序运行过程的描述
>初次进入小程序的时候，微信客户端初始化好宿主环境，同时从网络下载或者从本地缓存中拿到小程序的代码包，把它注入到宿主环境，初始化完毕后，微信客户端就会给App实例派发onLaunch事件，App构造器参数所定义的onLaunch方法会被调用。

>在某个小程序第一次启动时，微信需要下载小程序代码包。此后，如果小程序代码包未更新且还被保留在缓存中，则下载小程序代码包的步骤会被跳过。下载到的小程序代码包不是小程序的源代码，而是编译、压缩、打包之后的代码包。

从以上过程可知，获取小程序包的方式有两种：
1. 通过小程序的下载地址直接截取
  这种方式在之前被人发现后一度被大量拉取，官方很快发现后经过处理现已失效，目前具体下载地址以及鉴权方式未知
2. 小程序加载后在客户端获取
 这种方式理论上可行，但进入相应的目录需要root权限，由于真机root现在变得越来越麻烦也不安全，因此目前一般通过模拟器获取(这种方式暂未封，但是微信是可以检测出当前运行环境的，从而将来可以采取一些方式)。根据文档可知，获取的小程序代码是经过处理后的代码包，因而还原到开发的程序还需要经过反向编译。下面是具体实现过程：

# 2 实现

## 2.1 材料
1. 安卓模拟器：[夜神模拟器](https://www.yeshen.com/)
2. 微信、ES文件浏览器APK
3. 反编译脚本及环境
https://github.com/leo9960/wechat-app-unpack/

## 2.2 过程
1. 小程序源码文件

  下载[夜神模拟器](https://www.yeshen.com/)安装wechat 7.0.3后``闪退``

  换用winserver2012环境：``安装失败``：``显卡驱动版本低``

  换用geomotion模拟器:``无法安装微信``，提示ARM环境版本错误

{% note info %}
以前可以完整实现，目前暂时卡在这一步
{% endnote %}

2. 使用脚本解包为小程序典型文件结构  

# Reference

<small>
[1] 微信小程序团队.小程序开发指南[EB/OL].[https://0x9.me/Uk63r](https://developers.weixin.qq.com/ebook?action=get_post_info&docid=000c8a2f9ac0b0ab0086aafeb5d80a) .2018.
</small>