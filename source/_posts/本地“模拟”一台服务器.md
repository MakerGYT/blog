---
title: 本地“模拟”一台服务器
date: 2017-11-19 18:33:16
tags:
	- 配置
---
手头有租用阿里云的centos7的服务器，但目前它的角色既是实验机又是生产环境，感觉这样不太合适，于是产生了下面的需求
<!-- more -->
>在本地电脑上通过安装虚拟机，实现模拟与操作远程服务器一样的情形，这样将实验环境和生产环境隔离开，也起到本地验证的作用，提高项目的稳定性和安全性

## 前言

其实，顾名思义**模拟**操作，跟配置远程的服务器/虚拟主机操作是一模一样的，区别在于网络：
+ 远程服务器是有一个**公网IP**，也就是我们可以从其他联网的IP访问到它
+ 本地虚拟机是使用宿主机的网络，因而它分到的IP地址是一个**内网IP**，也就是说只能通过宿主机访问到。这一点就如同你用手上的设备访问你的路由器一样。

那么，基于网络的差异，也就决定了我们需要做以下两点：
1. 设置好虚拟机的网络
2. 改变某些参数使得宿主机能访问到“服务器”

#### 环境
+ 系统：`windows 10 pro 1703`
+ 工具：[VMware® Workstation 12 Pro](http://sw.bos.baidu.com/sw-search-sp/software/ca7ad8c6d3103/VMware-workstation-full-14.0.0.24051.exe)
+ 服务器系统:[centos 7.4.1](http://mirrors.aliyun.com/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1708.iso)
+ 服务器环境：`Apache 2.4.6` \ `php-5.4.16` \ `MariaDB-5.5.56` (`phpmyadmin 4.4.15.10`)

*已附下载链接，已测试且仅成功测试以上环境*
#### 名词解释
+ 宿主机：物理机，本地电脑

## 开工

### 安装centos虚拟机

#### 新建虚拟机
在此之前，默认你已经熟悉VMware且[新建](https://www.cnblogs.com/fzng/p/7228284.html?utm_source=itdadao&utm_medium=referral)了一台适合centos64位的虚拟机
这里需要注意两点：
1. 如果跳出不支持虚拟化，请在开机进入BIOS将virtual选项改为enable，具体机型具体百度
2. 选择自定义(高级)：
	+ 安装来源：稍后安装操作系统
	+ 选择客户机操作系统：CentOS 64位
	+ 位置：不要含中文、特殊字符、空格(所有软件安装不出错的基础要求【1】)
	+ 处理器配置、内存、磁盘容量：由于模拟，我设置跟服务器一样的
	+ 网络类型：**使用桥接网络***
	其余基本一路默认

#### 安装操作系统
1. 开启后，两项安装方式都可以，我这里选择第一项，Install CentOS 7
2. 安装语言我选择默认，English，避免乱码字符(所有软件安装不出错的基础要求【2】)
3. 安装信息摘要：
	+ 语言支持把Chinese加上
	+ 基本环境由于是模拟，选择最小安装，从头体验配置的操作(这里没有GUI桌面)
    + 安装位置：分区自动配置
    + 其余按提示或默认
4. 完成后重启以root登陆

### 配置虚拟机基础

#### 开启网络连接

先测试一下网络
```linux
[root@localhost ~]# ping -c 5 202.108.22.5 #ping百度的IP，5次
```

CentOS 7.4默认安装好之后是没有自动开启网络连接的，因此需要我们更改配置文件来开启网络
```linux
[root@localhost ~]# cd /etc/sysconfig/network-scripts
[root@localhost ~]# ls
ifcfg-enXXX ifdown-cth xxxxxxxx
···
#这里会列出该目录下所有脚本，注意第一个ifcfg-enXXX
[root@localhost ~]# vi ifcfg-enXXX
#这里用到vi基本操作，输入i，操作模式变为Insert，可写入
···
ONBOOT=yes #这里将no改成yes

```
然后Esc键退出insert模式，`:wq`保存退出，重启网卡：
```linux
[root@localhost ~]# service network start
#再次测试
[root@localhost ~]# ping -c 5 202.108.22.5 #ping百度的IP，5次
#有ttl回应，Ctrl+C退出`ping`
```
#### 安装vim
```linux 
[root@localhost ~]# yum install vim
#vim是支持命令行内的编辑器，yum 是一种便捷的安装方式，会自动安装依赖项
```
### 安装LAMP环境
#### 安装Apache
```linux
[root@localhost ~]# yum install httpd
#Apache的软件包名是httpd，服务名也是
```
出现提示时一路`y`
##### 启动Apache
```linux
[root@localhost ~]# systemctl start httpd.service
```
##### 允许开机启动Apache
```linux
[root@localhost ~]# systemctl enable httpd.service
#检查httpd服务状态：
[root@localhost ~]# systemctl status httpd.service
#验证：loaded为enables,Active为running
```
##### 防火墙开放tcp端口80：
```linux
[root@localhost ~]# firewall-cmd --zone=public --add-port=80/tcp --permanent
#重启防火墙
[root@localhost ~]# firewall-cmd --reload
#检查配置是否成功：
[root@localhost ~]# firewall-cmd --list-all
#验证：ports：80/tcp
```
##### 查询当前系统IP:
```linux
[root@localhost ~]# ip addr
#形如192.168.xxx 2中找inet第一个地址
```
此时，可在宿主机(你的物理机)浏览器访问该IP，会获取Apache欢迎页面
#### 安装php
```linux
[root@localhost ~]# yum install php
```
##### 安装完成后，

PHP生成三个配置文件
1. `/etc/httpd/conf.d/php.conf` 用于被Apache读取
2. `/etc/httpd/conf.modules.d/10-php.conf` 用于Apache加载LoadModule指定的模块(PHP模块)
3. `/etc/php.ini` php针对生产环境和开发环境自身的配置文件

##### 重启Apache
```linux
[root@localhost ~]# systemctl restart httpd
```
##### 测试Apache正常调用PHP
```linux
[root@localhost ~]# vim /var/www/html/phpinfo.php
<?php phpinfo ();?>
```
宿主机浏览器访问http://ip/phpinfo.php,如果正常的话可以看到php的安装信息
#### 安装MariaDB

> 从RHEL 7开始Red Hat公司推荐使用MariaDB替换MySQL,基础功能操作一样


```linux
[root@localhost ~]# yum install mariadb-server mariadb
```
##### 启动
```linux
[root@localhost ~]# systemctl start mariadb
[root@localhost ~]# systemctl status mariadb
#验证Active为running
```
##### 保护数据库

包括设置数据库的 root 密码、移除测试数据库test、移除匿名用户anonymous等
```linux
[root@localhost ~]# mysqlsecureinstallation
#出现提示时自行选择是否移除，这里暂不移除，选择n
```
##### 测试数据库

使用 root 账户登录 MariaDB 并用 quit 退出
```linux
[root@localhost ~]# mysql -u root -p
Enter password:
MariaDB [(none)]> SHOW VARIABLES;
```
##### 允许远程访问
```mysql
MariaDB [(none)]> grant all privileges on *.* to root@'%' identified by 'password' with grant option;
#允许任意ip以root身份password访问
MariaDB [(none)]> flush privileges;
#刷寻权限
```
测试一下在宿主机上navicat访问，*我测试时一般连接会迟滞，使用ssh连接正常*

#### 安装PhpMyAdmin
##### 安装库
CentOS 7.4 仓库默认没有提供 PhpMyAdmin 二进制安装包。如果不适应使用 MySQL 命令行来管理你的数据库，可以通过下面的命令启用 [CentOS
 7.4 rpmforge 仓库](http://fedoraproject.org/wiki/EPEL#How_can_I_use_these_extra_packages.3F) 来安装 PhpMyAdmin。
```linux
[root@localhost ~]# yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
#最新链接可在The newest version of ‘epel-release’ for EL7找到
[root@localhost ~]# yum install phpmyadmin
```
##### 配置

配置远程连接，使得能在宿主机上以http://ip/phpmyadmin访问
```linux
[root@localhost ~]# vi /etc/httpd/conf.d/phpMyAdmin.conf
<Directory /usr/share/phpMyAdmin/>
   AddDefaultCharset UTF-8

   <IfModule mod_authz_core.c>
     # Apache 2.4
     <RequireAny>
      # Require ip 127.0.0.1  #注释掉
      # Require ip ::1   #注释掉
      Require all granted   #新添加
     </RequireAny>
 </IfModule>
 <IfModule !mod_authz_core.c>
     # Apache 2.2
     Order Deny,Allow
     Deny from All
     Allow from 127.0.0.1
     Allow from ::1
   </IfModule>
</Directory>

<Directory /usr/share/phpMyAdmin/setup/>
   <IfModule mod_authz_core.c>
     # Apache 2.4
     <RequireAny>
      #Require ip 127.0.0.1  #注释掉
      #Require ip ::1   #注释掉
      Require all granted   #新添加
     </RequireAny>
   </IfModule>
   <IfModule !mod_authz_core.c>
     # Apache 2.2
     Order Deny,Allow
     Deny from All
     Allow from 127.0.0.1
     Allow from ::1
   </IfModule>
</Directory>
#保存退出
[root@localhost ~]# systemctl restart httpd
```
测试一下并登录http://ip/phpmyadmin
### 完工
现在可以使用xshell访问，xftp连接模拟上传下载文件，网站文件放在 /var/www/html下。也就是说开启VM让虚拟机跑起来，然后就可以忽略它是虚拟机的存在。

## 结语
安装配置总是条条大路，虽然总能通向罗马，但上路时需要带哪些“干粮”总是不一样的，“天气”也是无常的。相信常踩坑的同学可以理解这种比喻，以此作为本文声明。

*本文仅作为过程性记录，不具有一般适用性，本文采用https://makergyt.com/md 构建*

